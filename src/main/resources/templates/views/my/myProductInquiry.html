<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ìƒí’ˆ ë¬¸ì˜</title>

  <!-- ê³µí†µ ë ˆì´ì•„ì›ƒ CSS -->
  <link rel="stylesheet" th:href="@{/css/user/userCommon.css}" />
  <!-- í˜ì´ì§€ ì „ìš© CSS -->
  <link rel="stylesheet" th:href="@{/css/user/myProductInquiry.css}" />
</head>
<body>

  <!-- ê³µí†µ í—¤ë”/ì‚¬ì´ë“œë°” -->
  <div th:replace="~{common/myHeader}"></div>
  <div th:replace="~{common/mySidebar}"></div>

  <main class="page">
    <!-- ìƒë‹¨ íƒ€ì´í‹€ë°” -->
    <div class="page-topbar">
      <button class="icon-btn back" aria-label="ë’¤ë¡œ" onclick="history.back()">â†</button>
      <h1 class="page-title">ìƒí’ˆ ë¬¸ì˜</h1>
      <span class="spacer"></span>
    </div>

    <!-- ë‹¨ì¼ í¼ -->
    <form class="form" th:action="@{/my/product-question}" method="post" autocomplete="off">
      <!-- CSRF -->
      <input type="hidden" th:if="${_csrf != null}"
             th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

      <!-- ğŸ”¹ ì„ íƒëœ ìƒí’ˆ ë²ˆí˜¸(hidden). URLë¡œ ë„˜ì–´ì˜¤ë©´ ì„œë²„ê°€ ì±„ì›Œì¤Œ -->
      <input type="hidden" id="productNo" name="productNo" th:value="${productNo}" />

      <!-- ìƒí’ˆ ê²€ìƒ‰ -->
      <section class="card">
        <h2 class="sec-title" style="margin-bottom:8px">ìƒí’ˆ ê²€ìƒ‰</h2>
        <div class="search-bar">
          <input id="prodSearch" type="text" class="input" placeholder="ìƒí’ˆëª…ìœ¼ë¡œ ê²€ìƒ‰" />
        </div>
        <!-- í˜„ì¬ ì„ íƒ ìƒíƒœ í‘œì‹œ -->
        <div id="prodPicked" class="picked" aria-live="polite"
             th:text="${productNo != null} ? 'ì„ íƒëœ ìƒí’ˆë²ˆí˜¸: ' + ${productNo} : ''"></div>
        <!-- ê²€ìƒ‰ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ -->
        <div id="prodResults" class="results"></div>
      </section>

      <!-- ì œëª© -->
      <h2 class="sec-title">ë¬¸ì˜ ì œëª©</h2>
      <div class="field">
        <input type="text" class="input" name="questionTitle"
               placeholder="50ì ë¯¸ë§Œìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”" maxlength="50" required />
      </div>

      <!-- ë‚´ìš© -->
      <h2 class="sec-title">ë¬¸ì˜ ë‚´ìš©</h2>
      <div class="field">
        <textarea class="textarea" name="questionContent" rows="6" required
                  placeholder="ê°œì¸ì •ë³´(ì´ë¦„, ì—°ë½ì²˜ ë“±)ê°€ í¬í•¨ë˜ì§€ ì•Šë„ë¡ ì‘ì„±í•´ì£¼ì„¸ìš”"></textarea>
      </div>

      <!-- ì „ì†¡ -->
      <div class="submit-bar">
        <button id="submitBtn" type="submit" class="submit"
                th:disabled="${productNo == null}">
          íŒë§¤ìì—ê²Œ ì „ì†¡í•˜ê¸°
        </button>
      </div>
    </form>
  </main>

  <script th:inline="none">
  (function(){
    const $q = document.getElementById('prodSearch');
    const $list = document.getElementById('prodResults');
    const $picked = document.getElementById('prodPicked');
    const $productNo = document.getElementById('productNo');
    const $submit = document.getElementById('submitBtn');

    // URLë¡œ productNoê°€ ë“¤ì–´ì˜¨ ê²½ìš°, ë²„íŠ¼ í™œì„±í™”
    if ($productNo && $productNo.value) {
      $submit && $submit.removeAttribute('disabled');
    }

    let timer = null;
    function debounce(fn, delay){ if (timer) clearTimeout(timer); timer = setTimeout(fn, delay); }

    async function search(keyword){
      if (!keyword) { $list.innerHTML = ''; return; }
      const res = await fetch('/my/searchProduct?keyword=' + encodeURIComponent(keyword));
      if (!res.ok) throw new Error('ê²€ìƒ‰ ì‹¤íŒ¨');
      return res.json();
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    function render(items){
      if (!Array.isArray(items) || items.length === 0){
        $list.innerHTML = '<p class="helper">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }
      $list.innerHTML = items.map(it=>{
        const id = escapeHtml(String(it.productNo??''));
        const name = escapeHtml(it.productName||'(ìƒí’ˆëª… ì—†ìŒ)');
        const detail = escapeHtml((it.productDetail||'').replace(/\s+/g,' ').trim());
        const thumb = escapeHtml(it.thumbUrl||'/uploadFilesFinal/default-product.png');
        return `
          <button type="button" class="result" data-no="${id}" data-name="${name}">
            <img src="${thumb}" alt="" onerror="this.onerror=null;this.src='/uploadFilesFinal/default-product.png'">
            <div class="meta">
              <div class="title">${name}</div>
              <div class="desc">${detail}</div>
            </div>
          </button>
        `;
      }).join('');
    }

    $q && $q.addEventListener('input', ()=>{
      const kw = $q.value.trim();
      debounce(async ()=>{
        try{
          const data = await search(kw);
          render(data);
        }catch(e){
          console.error(e);
          $list.innerHTML = '<p class="helper">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
        }
      }, 250);
    });

    $list && $list.addEventListener('click', (e)=>{
      const item = e.target.closest('.result');
      if (!item) return;
      const no = item.getAttribute('data-no');
      const name = item.getAttribute('data-name')||'';
      $productNo.value = no;
      $picked.textContent = `ì„ íƒëœ ìƒí’ˆ: [${no}] ${name}`;
      $submit && $submit.removeAttribute('disabled');

      // ì‹œê° í”¼ë“œë°±
      [...$list.querySelectorAll('.result')].forEach(el=>el.classList.remove('is-selected'));
      item.classList.add('is-selected');
    });
  })();
  </script>
</body>
</html>
