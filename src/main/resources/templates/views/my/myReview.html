<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë¦¬ë·° ì“°ê¸°</title>
  <!-- ê³µí†µ ë ˆì´ì•„ì›ƒ CSS -->
  <link rel="stylesheet" th:href="@{/css/user/userCommon.css}" />
  <!-- í˜ì´ì§€ ì „ìš© CSS -->
  <link rel="stylesheet" th:href="@{/css/user/myReview.css}" />
  <!-- ì•„ì´ì½˜ CDN (v6) -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css">

  <style>
    .order-body { display:flex; align-items:center; justify-content:space-between; }
    .order-image { width:130px; height:130px; background-color:#ccc; display:flex; align-items:center; justify-content:center; margin-right:15px; margin-top:1%; border-radius:6px; }
    .order-info { flex:1; }
    .order-info p { margin:3px 0; }
    .order-info .price { color:#8ad8f0; font-weight:bold; }
    .order-info .name { color:gray; }
    .company { font-size:18px; font-weight:bold; }
  </style>
</head>
<body>

  <!-- ì „ì—­ í—¤ë” (ê³µí†µ) -->
  <div th:replace="~{common/myHeader}"></div>

  <!-- ì „ì—­ ì‚¬ì´ë“œë°” (ê³µí†µ) -->
  <div th:replace="~{common/mySidebar}"></div>

  <main class="page">
    <!-- ìƒë‹¨ íƒ€ì´í‹€ë°” -->
    <div class="page-topbar">
      <button class="icon-btn back" type="button" onclick="history.back()" aria-label="ë’¤ë¡œ">â†</button>
      <h1 class="page-title">ë¦¬ë·° ì“°ê¸°</h1>
      <button class="icon-btn help" aria-label="ë„ì›€ë§">?</button>
    </div>

    <!-- ì•ˆë‚´ ë°°ë„ˆ -->
    <section class="card tip-banner">
      <div class="tip-text">
        ë„ì›€ì´ ë˜ëŠ” ë¦¬ë·°ë¥¼ ë§ì´ ì“¸ìˆ˜ë¡<br/>
        ì²´í—˜ë‹¨ ì„ ì • í™•ë¥ ì´ ì˜¬ë¼ê°€ìš”
      </div>
    </section>

    <!-- ì œí’ˆ ê²€ìƒ‰ -->
    <section class="block" th:if="${order == null}">
      <h2 class="block-title req">ë¦¬ë·°ë¥¼ ì“°ê³  ì‹¶ì€ ì œí’ˆì„ ê²€ìƒ‰í•´ ë³´ì„¸ìš”</h2>
      <div class="search-box">
        <span class="search-ic">ğŸ”</span>
        <input class="search-input" type="text" placeholder="ì œí’ˆëª…ì´ë‚˜ ì„±ë¶„ëª…ìœ¼ë¡œ ì°¾ì•„ë³´ì„¸ìš”"/>
      </div>
    </section>

	
	
    <!-- ì„œì—° -->
    <div class="order-body" th:if="${order != null}">
      <div class="order-image">
        <img th:if="${attachment.positionNo == order.productNo}"
             th:src="@{'/' + ${attachment.attmRename}}"
             width="100%" height="100%"
             style="border-radius:8px; object-fit:contain;" />
      </div>
      <div class="order-info">
        <p class="price" th:text="${#numbers.formatInteger(order.productPrice,3,'COMMA')} + 'ì›'"></p>
        <p class="company">[[${order.productCompany}]]</p>
        <p class="name">[[${order.productName}]]</p>
      </div>
    </div>

    <!-- ê²€ìƒ‰ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ -->
    <section class="block" style="margin-top:16px">
      <div id="searchResults" class="card" style="display:none;padding:12px"></div>
    </section>

    <hr class="divider"/>

    <!-- ë¦¬ë·° ì‘ì„± í¼ -->
    <form th:action="@{/my/review}" method="post" id="reviewForm">
      <input type="hidden" name="productNo" id="productNo">

      <!-- ë³„ì  -->
      <section class="block">
        <h2 class="block-title center req">ì´ ì œí’ˆ ì–´ë– ì…¨ë‚˜ìš”?</h2>
        <div class="stars">
          <input type="radio" id="star5" name="reviewRate" value="5"/><label for="star5"></label>
          <input type="radio" id="star4" name="reviewRate" value="4"/><label for="star4"></label>
          <input type="radio" id="star3" name="reviewRate" value="3"/><label for="star3"></label>
          <input type="radio" id="star2" name="reviewRate" value="2"/><label for="star2"></label>
          <input type="radio" id="star1" name="reviewRate" value="1"/><label for="star1"></label>
        </div>
      </section>

      <!-- ë¦¬ë·° ë‚´ìš© -->
      <section class="block">
        <h3 class="q-title pos">ì¢‹ì•˜ë˜ ì  í˜¹ì€ ë‚˜ë§Œì˜ íŒ <span class="req-dot">*</span></h3>
        <textarea class="ta" name="reviewContent" rows="5"
                  placeholder="ì œí’ˆì„ ì‚¬ìš©í•œ ë‚ ì§œì™€ ê¸°ê°„, ì¢‹ì•˜ë˜ ì ì„ ìì„¸íˆ ë‚¨ê²¨ì£¼ì„¸ìš”" required></textarea>
        <div class="count">0/5,000 (ìµœì†Œ 20ì)</div>
      </section>

      <!-- ì•ˆë‚´ì‚¬í•­ -->
      <section class="notice card">
        <ul>
          <li>ì œí’ˆê³¼ ë¬´ê´€í•œ ì‚¬ì§„ì„ ì²¨ë¶€í•˜ê±°ë‚˜ ì‚¬ì´íŠ¸ ê¸°ì¤€ì— ë§ì§€ ì•ŠëŠ” ë‚´ìš© ì‘ì„± ì‹œ ë¦¬ë·° ìˆ˜ì • ìš”ì²­ì„ ë“œë¦¬ë©°, ë‹¤ìŒ ì˜ì—…ì¼ ë‚´ì— ê²€ìˆ˜í•˜ì—¬ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë©ë‹ˆë‹¤. (ì£¼ë§/ê³µíœ´ì¼ ì œì™¸)</li>
        </ul>
      </section>

      <!-- í•˜ë‹¨ CTA -->
      <div class="submit-wrap">
        <button type="submit" class="primary big">ë¦¬ë·° ë“±ë¡í•˜ê¸°</button>
      </div>
    </form>
  </main>

  <!-- JS -->
  <script>
  (function(){
    const $input = document.querySelector('.search-input');
    const $list  = document.getElementById('searchResults');
    const $productNo = document.getElementById('productNo');

    // ë³´ì¡° í•¨ìˆ˜
    function stripHtml(html){
      if(!html) return '';
      return html.replace(/<script[\s\S]*?<\/script>/gi,' ')
                 .replace(/<style[\s\S]*?<\/style>/gi,' ')
                 .replace(/<[^>]+>/g,' ')
                 .replace(/\s+/g,' ')
                 .trim();
    }
    function truncate(s, n){ return s && s.length > n ? s.slice(0, n) + 'â€¦' : (s || ''); }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // ê²€ìƒ‰ê²°ê³¼ ë Œë”
    function render(list){
      if(!list || list.length === 0){
        $list.style.display = 'none';
        $list.innerHTML = '';
        return;
      }
      $list.style.display = 'block';
      $list.innerHTML = list.map(p => {
        const name = escapeHtml(p.productName || '');
        const desc = truncate(stripHtml(p.productDetail || ''), 100);
        const thumb = p.thumbUrl || '/default-product.png';
        return `
          <div class="row" data-no="${p.productNo}"
               style="display:grid;grid-template-columns:64px 1fr auto;gap:12px;align-items:center;padding:10px 0;border-top:1px solid #eee">
            <img src="${thumb}" alt="${name}" style="width:64px;height:64px;border-radius:8px;object-fit:cover;background:#f3f4f6"
                 onerror="this.onerror=null;this.src='/default-product.png';" />
            <div>
              <div style="font-weight:700">${name}</div>
              <div style="font-size:12px;color:#666;margin-top:2px">${desc}</div>
            </div>
            <button type="button" class="mini-btn"
                    style="padding:6px 10px;border:1px solid #34e5eb;border-radius:6px;background:#eefbfb;color:#34e5eb;font-weight:600;cursor:pointer">
              ì„ íƒ
            </button>
          </div>
        `;
      }).join('');

      // ì„ íƒ ë²„íŠ¼
      $list.querySelectorAll('.row .mini-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const row = e.target.closest('.row');
          const no  = row.getAttribute('data-no');
          $productNo.value = no;
          $list.querySelectorAll('.row').forEach(r=>r.style.background='transparent');
          row.style.background = '#f0f9ff';
        });
      });
    }

    let timer;
    if($input){
      $input.addEventListener('input', function(){
        const q = this.value.trim();
        clearTimeout(timer);
        if(q.length < 1){ render([]); return; }
        timer = setTimeout(()=>{
          fetch(`/my/searchProduct?keyword=` + encodeURIComponent(q))
            .then(r=>r.json())
            .then(render)
            .catch(()=>render([]));
        }, 250);
      });
    }

    // ì œì¶œ ì „ ì œí’ˆ ì„ íƒ í™•ì¸
    document.getElementById('reviewForm').addEventListener('submit', function(e){
      if(!$productNo.value){
        e.preventDefault();
        alert('ë¦¬ë·°ë¥¼ ì‘ì„±í•  ì œí’ˆì„ ë¨¼ì € ê²€ìƒ‰í•´ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.');
      }
    });
  })();
  </script>
</body>
</html>
