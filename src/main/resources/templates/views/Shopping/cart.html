<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>ì¥ë°”êµ¬ë‹ˆ</title>
<script src="https://code.jquery.com/jquery-3.7.1.js"
	integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
	crossorigin="anonymous"></script>
<link rel="stylesheet" th:href="@{/css/user/userCommon.css}" />

<!-- ì•„ì´ì½˜(CDN) -->
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
	integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
	crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
body {
	background: #f7f8f9;
}

.all {
	margin-right: 5%;
	margin-left: 7%;
	margin-bottom: 3%;
	margin-top: 2%;
}

.check {
	margin-bottom: 1%;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 8px;
}

input[type="checkbox"]:indeterminate {
	transform: scale(1.5);
	margin-right: 8px;
	accent-color: lightgray;
}

#checkdelete {
	float: right;
	font-size: 16px;
	background: none;
	border: none;
	color: gray;
}

#checkdelete:hover {
	font-weight: bold;
	color: black;
}

.cart-header {
	margin-bottom: 1%;
	margin-top: 1%;
}



.delete-btn:hover {
	color: black;
	font-weight: bold;
}

.cartitem {
	border: 1px solid #ccc;
	border-radius: 6px;
	box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
	align-items: center;
	padding: 10px 16px;
	margin-top: 15px;
	margin-bottom: 18px;
	margin-left: 1%;
	margin-right: 1%;
}

.cart-header label {
	font-weight: bold;
	font-size: 18px;
}

.cart-body {
	display: flex;
	align-items: center;
	gap: 10px;
	margin-right: 1%;
	position:relative;
	margin-left: 1%;
	margin-bottom:1%;
	margin-top:2%;
}

.delete-btn {
  position: absolute;
  top: 0;   
  right:0 ; 
  background: none;
  border: none;
  color: gray;
  font-size: 15px;
  cursor: pointer;
}

.item-image {
	width: 130px;
	height: 130px;
	display: flex;
	align-items: center;
	justify-content: center;
	font-size: 12px;
	margin-right: 10px;
	margin-bottom: 10px;
	border-radius: 6px;
	position: relative;
}
.soldout {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.5);   
  color: #fff;
  font-size: 18px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;               
}
.unavailable {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.5);   
  color: #fff;
  font-size: 18px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;               
}

.quantity {
	margin-top: 18px;
}

.item-name {
	font-size: 18px;
	color: gray;
}
.item-name a {
  text-decoration: none; 
  color: inherit;  
  font-size: 18px;      
}


.item-price {
	color: #8ad8f0;
	font-weight: bold;
	margin-top: 0;
	margin-bottom: 12px;
	margin-left: auto;
	font-size: 18px;
}

.payment {
	margin-left: 2%;
	margin-right: 2%;
	font-weight: bold;
}

p.predict {
	font-size: 20px;
	font-weight: bold;
	margin-top: 2%;
	margin-bottom: 0;
}

p.total-price {
	color: gray;
	font-size: 18px;
	margin-top: 2%;
}

p.coupon-notice {
	color: gray;
	font-size: 18px;
	margin: 0; /* p íƒœê·¸ ê¸°ë³¸ ì—¬ë°± ì œê±° */
}

select[name="coupon-option"] {
	color: rgb(0, 0, 0);
	font-size: 16px;
	text-decoration: none;
	height: 40px;
	width: 30%;
	border: 1px solid #34e5eb;
	border-radius: 6px;
}

.coupon {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin: 5px 0;
	font-size: 18px;
}

.total {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin: 5px 0;
	font-size: 18px;
	line-height: 1;
}

.total-price {
	color: gray;
}

.total-product {
	color: gray;
}

.total-coupon {
	color: gray;
}

.total-discount-price {
	color: gray;
}

.point {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin: 5px 0;
	font-size: 18px;
	line-height: 1;
}

.point-exception {
	color: gray;
}

.point-amount {
	color: gray;
}

#product-order {
	display: block;
	width: 100%;
	padding: 13px 0;
	background-color: #eefbfb;
	color: black;
	font-size: 18px;
	font-weight: bold;
	border: none;
	border-radius: 5px;
	cursor: pointer;
	border: 1px solid #c2e4e4;
}

#product-order:hover {
	color: white;
	background: #8ad8f0;
}

.qty-btn {
	display: inline-flex;
	justify-content: center;
	align-items: center;
	width: 30px;
	height: 30px;
	line-height: 1;
	padding: 0;
	vertical-align: middle;
}

.minus {
	background: white;
	color: black;
	border: 1px solid #ccc;
	border-radius: 50%;
	font-weight: bold;
	font-size: 18px;
}

.minus:hover {
	background: gray;
	color: white;
}

.plus {
	background: #eefbfb;
	color: gray;
	border: 1px solid #ccc;
	border-radius: 50%;
	font-weight: bold;
	font-size: 18px;
}

.plus:hover {
	background: #8ad8f0;
	color: white;
}

.qty-btn:disabled,
.qty-btn:disabled:hover {
	background-color: lightgray !important;
	color: #999 !important;
	cursor: not-allowed !important;
	opacity: 0.6 !important;
	pointer-events:none;
}

 
</style>
</head>
<body>
	<!-- ì „ì—­ í—¤ë” (ê³µí†µ) -->
	<header class="site-header">
		<a href="index">It:View</a>
	</header>

	<!-- ì „ì—­ ì‚¬ì´ë“œë°” (ê³µí†µ) : ì•„ì´ì½˜ êµ¬ì¡°ë¡œ êµì²´ -->
	<nav class="sidenav" aria-label="Primary">
		<div class="sidenav-top">
			<a class="nav-item active" href="/my/myInfo"><i
				class="fa-solid fa-user"></i><span>ë§ˆì´í˜ì´ì§€</span></a> <a class="nav-item"
				href="/experience/experienceApplication"><i
				class="fa-solid fa-gift"></i><span>ì²´í—˜ë‹¨ ì‹ ì²­</span></a> <a class="nav-item"
				href="/my/myReview"><i class="fa-solid fa-star"></i><span>ë¦¬ë·°</span></a>
			<a class="nav-item" href="/Shopping/cart"><i
				class="fa-solid fa-cart-shopping"></i><span>ì¥ë°”êµ¬ë‹ˆ</span></a> <a
				class="nav-item" href="/Shopping/WishList"><i
				class="fa-solid fa-heart"></i><span>ì°œ</span></a> <a class="nav-item"><i
				class="fa-solid fa-right-from-bracket"></i><span>ë¡œê·¸ì•„ì›ƒ</span></a>
		</div>
	</nav>
	<div class="all">
		<div class="check">
			<label><input type="checkbox" id="checkAll">ì „ì²´ì„ íƒ</label>
			<button type="submit" id="checkdelete">ì„ íƒì‚­ì œ</button>
		</div>
		<hr>
		<div th:if="${#lists.isEmpty(clist)}" class="cart-empty">
   			<p>ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.</p>
		</div>
		<div class="cartitem" th:if="${!#lists.isEmpty(clist)}"
			th:each="c:${clist}">
			
			
			
			<div class="cart-header">
				<label><input type="checkbox" class="checkcompany"
					th:value="${c.cartNo}" th:data-company="${c.productCompany}" >[[${c.productCompany}]]</label>

			</div>
			
			<div  class="cart-body">
				<label><input type="checkbox" class="checkItem"
					th:value="${c.cartNo}" th:data-company="${c.productCompany}" th:disabled="${c.productStock == 0 or c.productState == 'N'}"></label>
				<div class="item-image">
					<a th:href="@{#}">
						<img th:each="a:${alist}" th:if="${a.positionNo==c.productNo}"
						th:src="@{/uploadFilesFinal/product/{file}(file=${a.attmRename})}"
						width="100%" height="100%" style="border-radius: 8px;" />
					</a>
					<div th:if="${c.productStock == 0 && c.productState =='Y'}" class="soldout">
    					í’ˆì ˆ
  					</div>
  					<div th:if="${c.productState == 'N'}" class="unavailable">
    					íŒë§¤ì¤‘ì§€
  					</div>
				</div>
				
				<div class="item">
					<div class="item-price" th:data-price="${c.productPrice}"
						th:text="${#numbers.formatInteger(c.productPrice * c.amount,3,'COMMA')}+'ì›'">ê°€ê²©</div>
					<div class="item-name">
						<a th:href="@{#}">
							<span th:text="${c.productName}">ì´ë¦„</span>
						</a>
					</div>

					<div class="quantity">
						<button class="qty-btn minus" type="button">-</button>
						<span th:text="${c.amount}" class="qty"
							th:data-stock="${c.productStock}"
     						th:data-state="${c.productState}">ê°¯ìˆ˜</span>
						<button class="qty-btn plus" type="button">+</button>
					</div>
				</div>
				<button type="button" class="delete-btn"
					th:data-cartno="${c.cartNo}">X</button>
			</div>
			</div>
		

	
		
		<hr>
		<div class="payment">
			<p class="predict">ì˜ˆìƒê²°ì œê¸ˆì•¡</p>

			<div class="total">
				<p class="total-price">ì´ ìƒí’ˆê¸ˆì•¡</p>
				<p class="total-product" style="color: black;">0ì›</p>
			</div>
			<div class="coupon">
				<p class="coupon-notice">ì¿ í°í• ì¸</p>
				<select id="sort" name="coupon-option">
					<option value="notice" selected>ì¿ í°ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
					<option value="all" th:each="coupon:${couponlist}"
										th:attr="data-brand=${coupon.">[[${coupon.couponName}]]</option>
					
				</select>
			</div>
			<div class="total">
				<p class="total-coupon">ì´ ì£¼ë¬¸ê¸ˆì•¡</p>
				<p class="total-discount-price" style="color: black;">(ì¿ í°ì ìš©í•œê°€ê²©)</p>
			</div>
			<div class="point">
				<p class="point-exception">ì˜ˆìƒ ì ë¦½ í¬ì¸íŠ¸</p>
				<p class="point-amount" style="color: black;">(í¬ì¸íŠ¸ ì ë¦½)</p>
			</div>
		</div>
		<button type="submit" id="product-order">ìƒí’ˆ ì£¼ë¬¸í•˜ê¸°</button>
	</div>
</body>
<script>
	window.onload=()=>{
		const all = document.getElementById('checkAll');
		const items = document.querySelectorAll('.checkItem');
		const checkdelete = document.getElementById('checkdelete');
		const deleteBtn = document.querySelectorAll('.delete-btn');
		const checkCompany = document.querySelectorAll('.checkcompany');
		
		
		const minusBtn = document.querySelectorAll('.qty-btn.minus');
		const plusBtn=document.querySelectorAll('.qty-btn.plus');
		const qtySpan=document.querySelectorAll('.qty');
		
		const itemPrice=document.querySelectorAll('.item-price');
		const cartItem=document.querySelectorAll('.cartitem');
		const totalProduct = document.querySelector('.total-product');
		

		
		checkCompany.forEach(chkbrd => {
			  chkbrd.addEventListener('change', () => {
			    const company = chkbrd.dataset.company;

			    
			    items.forEach(item => {
			      if (item.dataset.company === company && !item.disabled) {
			        item.checked = chkbrd.checked;
			      }
			    });

			  
			    const total = items.length;
			    const checked = [...items].filter(c => c.checked).length;

			    
			    all.checked = (checked === total);
			    all.indeterminate = (checked > 0 && checked < total);
			    
			    let sum=0;
				cartItem.forEach(product=>{
					if(product.querySelector('.checkItem').checked){
						const unit = parseInt(product.querySelector('.item-price').dataset.price);
						const qty=parseInt(product.querySelector('.qty').textContent);
						sum+=unit*qty;
					}
				});
				
				totalProduct.textContent=sum.toLocaleString()+'ì›';
			  });
			});

	
		
		if(all != null){
			all.addEventListener('change',()=>{
				for(let i =0; i<items.length; i++){
					if(!items[i].disabled){
						items[i].checked=all.checked;
					}
				}
				
				checkCompany.forEach(chkbrd=>{
					chkbrd.checked=all.checked;
					chkbrd.indeterminate=false;
					});
				
				
				all.indeterminate = false;
				
				let sum=0;
				cartItem.forEach(product=>{
					if(product.querySelector('.checkItem').checked){
						const unit = parseInt(product.querySelector('.item-price').dataset.price);
						const qty=parseInt(product.querySelector('.qty').textContent);
						sum+=unit*qty;
					}
				});
				
				totalProduct.textContent=sum.toLocaleString()+'ì›';
			});
		
		
				
				
			
			
			items.forEach(check =>{
				check.addEventListener('change',()=>{
					const total = items.length;
					//itemì— ë“¤ì–´ì‡ëŠ” ê°œë³„ ì²´í¬ë°•ìŠ¤ë“¤ ì¤‘ì—ì„œ ì²´í¬ëœ ê²ƒë§Œ ê³¨ë¼ì„œ ê·¸ ê°œìˆ˜ë¥¼ ì…ˆ
					// [...]->ì´ê²Œ nodelistë¥¼ ë°°ì—´ë¡œ ë³€í™˜í•˜ëŠ”ê²ƒ 
					//filer-> ë°°ì—´ì„ í›‘ìœ¼ë©´ì„œ ì¡°ê±´ì„ í†µê³¼í•˜ëŠ” ìš”ì†Œë§Œ ëª¨ì•„ì„œ ìƒˆ ë°°ì—´ì„ ë°˜í™˜ 
					//ì¦‰ ì²´í¬ëœ ë°•ìŠ¤ë“¤ë§Œ ê±¸ëŸ¬ì„œ ë°°ì—´ë¡œ ë§Œë“ ë‹¤
					const checked = [...items].filter(c=>c.checked).length;
					const company=check.dataset.company;
					const companyCheckbox = [...checkCompany].find(cb => cb.dataset.company === company);
					const companyItems = [...items].filter(i => i.dataset.company === company);
					const checkedCount = companyItems.filter(i => i.checked).length;
					
					
					
					companyCheckbox.checked = (checkedCount === companyItems.length);
					companyCheckbox.indeterminate = (checkedCount > 0 && checkedCount < companyItems.length);
					
					    
					all.checked=(checked===total);
					
					//ì¼ë¶€ë§Œ ì„ íƒëœ ìƒíƒœë©´ 'ì „ì²´ì„ ì±…'ì²´í¬ë°•ìŠ¤ë¥¼ íšŒìƒ‰ ìƒíƒœë¡œ ë§Œë“ ë‹¤
					//indeterminateëŠ” jsì—ë§Œ ì‡ëŠ” ìš”ì†Œ
					//ì²´í¬ëœê°œìˆ˜ > 0(ì ì–´ë„ í•˜ë‚˜ëŠ” ì²´í¬ë¨), ì²´í¬ëœ ê°œìˆ˜<total(ì¼ë¶€ë§Œ)->ì¼ë¶€ë§Œ ì²´í¬ë˜ë©´ true
					all.indeterminate=(checked>0 && checked < total);
					
					let sum=0;
					cartItem.forEach(product=>{
						if(product.querySelector('.checkItem').checked){
							const unit = parseInt(product.querySelector('.item-price').dataset.price);
							const qty=parseInt(product.querySelector('.qty').textContent);
							sum+=unit*qty;
						}
					});
					
					totalProduct.textContent=sum.toLocaleString()+'ì›';
					
					
				});
				
			})
			
		}
		
		if(checkdelete != null){
			checkdelete.addEventListener('click',()=>{
				const checkedItems=[];
				
				for(let i =0; i<items.length; i++){
					if(items[i].checked){
						checkedItems.push(items[i].value);
					}
				}
				
				if(checkedItems.length === 0){
					alert('ì‚­ì œí•  ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”.');
					return;
				}
			
				if(confirm('ì„ íƒí•œ ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
					$.ajax({
						url:'/Shopping/checkDelete',
						type:'post',
						traditional:true,
						data:{cartNo:checkedItems},
						success: data =>{
							if(data > 0){
								alert('ì„ íƒí•œ ìƒí’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
								location.reload();
							}else{
								alert('ìƒí’ˆ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
							}
						},
						error:data => console.log(data)
					});
					
				}
			});
			
		}	
			
		
		deleteBtn.forEach(btn=>{
			btn.addEventListener('click',()=>{
				
				const cartNo=btn.dataset.cartno;
				
				if(cartNo!=null){
					if(confirm('ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
						$.ajax({
							url:'/Shopping/productDelete',
							type:'post',
							data:{cartNo:cartNo},
							success: data =>{
								if(data > 0){
									alert('ìƒí’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
									location.reload();
								}else{
									alert('ìƒí’ˆ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
								}
							},
							error:data => console.log(data)
						});
					}
	
				}
			});
		})
		
		
		
		
		
		qtySpan.forEach((span,i)=>{
			const qty=parseInt(span.textContent);
			const stock=parseInt(qtySpan[i].dataset.stock);
			const state=span.dataset.state;
			
			if(stock==0 || state=='N'){
				minusBtn[i].disabled=true;
				plusBtn[i].disabled=true;
			}
			
			
			if(qty===1){
				minusBtn[i].disabled=true;
			}
			if(qty>=stock){
				plusBtn[i].disabled=true;
			}
		});
		
		
		
		minusBtn.forEach((btn,i)=>{
			btn.addEventListener('click',()=>{
				let qty=parseInt(qtySpan[i].textContent);
				const stock=parseInt(qtySpan[i].dataset.stock);
				if(qty>1){
					qty=qty-1;
					qtySpan[i].textContent=qty;
				}
				
				if(qty===1){
					btn.disabled=true;
				}else{
					btn.disabled=false;
				}
				
				if(qty<stock){
					plusBtn[i].disabled=false;
				}
				
				const item=parseInt(itemPrice[i].dataset.price);
				const total=item * qty;
				itemPrice[i].textContent=total.toLocaleString()+'ì›'
				
				let sum=0;
				cartItem.forEach(product=>{
					if(product.querySelector('.checkItem').checked){
						const unit = parseInt(product.querySelector('.item-price').dataset.price);
						const qty=parseInt(product.querySelector('.qty').textContent);
						sum+=unit*qty;
					}
				});
				
				totalProduct.textContent=sum.toLocaleString()+'ì›';
				
			});
		});
		
		plusBtn.forEach((btn,i)=>{
			btn.addEventListener('click',()=>{
				let qty=parseInt(qtySpan[i].textContent);
				const stock=parseInt(qtySpan[i].dataset.stock);
				
				if(qty<stock){
					qty=qty+1;
					qtySpan[i].textContent=qty;
					
					if(qty===1){
						minusBtn[i].disabled=true;
					}else{
						minusBtn[i].disabled=false;
					}
					const item=parseInt(itemPrice[i].dataset.price);
					const total=item * qty;
					itemPrice[i].textContent=total.toLocaleString()+'ì›'
				}else{
					alert('ìƒí’ˆì´ ë” ì´ìƒ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ğŸ˜…');
				}
				
				if(qty===stock){
					alert('ë§ˆì§€ë§‰ ìƒí’ˆì…ë‹ˆë‹¤.');
					btn.disabled=true;
				}
				let sum=0;
				cartItem.forEach(product=>{
					if(product.querySelector('.checkItem').checked){
						const unit = parseInt(product.querySelector('.item-price').dataset.price);
						const qty=parseInt(product.querySelector('.qty').textContent);
						sum+=unit*qty;
					}
				});
				
				totalProduct.textContent=sum.toLocaleString()+'ì›';
			});
			
		});	
		
		
		
		
		
	}
	
	
	
		
	
</script>
</html>